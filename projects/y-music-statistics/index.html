<!doctype html>
<html lang="en">
    <head>
        <!-- META TAGS -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <!-- PUBLIC -->
        <title>YouTube Music Unofficial Statistics</title>
        <meta name="site_name" content="hey, I'm Index">
        <meta name="description" content="who is Index anyway?">
    
        <!-- CSS -->
        <link rel="stylesheet" href="/style.css" type="text/css">
        <link href="https://cdn.jsdelivr.net/npm/halfmoon@2.0.1/css/halfmoon.min.css" rel="stylesheet" integrity="sha256-SsJizWSIG9JT9Qxbiy8xnYJfjCAkhEQ0hihxRn7jt2M=" crossorigin="anonymous">
    
        <!-- JAVASCRIPT -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    </head>
    <body data-bs-theme="dark">
        <style>
        small {
            margin-bottom: 10px;
        }
        </style>
        <div id="notice-page" class="small-page text-center">
            <small class="text-muted"><a href="/" class="text-decoration-none"><- go back</a></small>
            <h1>YouTube Music Statistics</h1>
            <p>Ever wondered how much of your year was spent dedicated to music? Are you also a YouTube Music user? Well! You're in luck! Upload your YouTube Music listening history (known as "watch history") as a JSON file here to get your yearly recap early. To get your listening history, go to <a href="https://takeout.google.com/">Google Takeout</a> and request a download of your YouTube Music "watch history" in a <code>.JSON</code> format. This project is open-sourced on GitHub <a href="https://github.com/IndexingGitHub/IndexingGitHub/tree/main/projects/music-statistics" target="_blank">here</a> and no data ever leaves your device. All processing done to generate your statistics is done in JAVASCRIPT; a client-sided browser language.</p>
            <input id="file" type="file" accept="application/json">
            <br>
            <br>
            <small>(I am not affiliated with YouTube, YouTube Music, or Google)</small>
        </div>
        <main id="page" class="container d-none">
            <div class="row">
                <div class="col-md-5">
                    <small>ARTISTS</small>
                    <hr>
                </div>
                <div class="col">
                    <small>SONGS</small>
                    <hr>
                </div>
            </div>
            <div class="row" id="data">
                Loading..
            </div>
        </main>
        <script>
            const Page = document.getElementById('page')
            const Data = document.getElementById('data')

            const URLParams = new URLSearchParams(new URL(window.location.href).search)
            const Year = parseInt(URLParams.get('year')) || new Date().getFullYear()

            const FileSelect = document.getElementById('file')
            FileSelect.click()
            FileSelect.addEventListener('change', function(){
                const File = FileSelect.files[0]
                const Reader = new FileReader()
                Reader.addEventListener('loadend', function(){
                    Load(JSON.parse(Reader.result))
                });
                Reader.readAsText(File)
            });

            let MusicHistory = []
            let ThisYear = []
            let SongPlays = []
            let MostPlayed = []
            let ArtistPlays = []
            let MostActiveArtist = []
            let MostPlayedByArtist = []
            let EarliestTime = { hour: 12, type: "AM" }
            let LatestTime = { hour: 12, type: "AM" }
            let DaysOfTheWeek = [
                {day: "Sunday", plays: 0},
                {day: "Monday", plays: 0},
                {day: "Tuesday", plays: 0},
                {day: "Wednesday", plays: 0},
                {day: "Thursday", plays: 0},
                {day: "Friday", plays: 0},
                {day: "Saturday", plays: 0}
            ]
            let MostActiveWeekDay = null

            function Load(data) {
                if (new URLSearchParams(new URL(window.location.href).search).get('load') === 'false') { return }
                MusicHistory = data.filter((x) => x.header === "YouTube Music")
                ThisYear = MusicHistory.filter((x) => new Date(x.time).getFullYear() === Year)
                
                ThisYear.forEach(song => {
                    if (song.subtitles !== undefined) {
                        const Creator = song.subtitles[0].name.replace(' - Topic', '') || null;

                        const Title = song.title.replace('Watched ', '')
                        const SongExists = SongPlays.findIndex(play => play.name === Title)
                        if (SongExists !== -1) {
                            SongPlays[SongExists].plays++
                            DaysOfTheWeek[new Date(song.time).getDay()].plays++
                            if (MostPlayedByArtist[Creator] === undefined) { MostPlayedByArtist[Creator] = {name: "", plays: 0}}
                            if (SongPlays[SongExists].plays > (MostPlayedByArtist[Creator].plays || 0)) {
                                MostPlayedByArtist[Creator].name = Title
                                MostPlayedByArtist[Creator].plays = SongPlays[SongExists].plays
                            }
                        } else {
                            SongPlays.push({name: Title, artist: Creator, plays: 1})
                        }

                        const ArtistExists = ArtistPlays.findIndex(artist => artist.name === Creator);
                        if (ArtistExists !== -1) {
                            ArtistPlays[ArtistExists].plays++;
                        
                            /*
                            if (ArtistPlays[ArtistExists].lastPlayed > new Date(song.time).getTime()) {
                                ArtistPlays[ArtistExists].lastPlayed = new Date(song.time).getTime()
                            }
                            */
                        } else {
                            ArtistPlays.push({ name: Creator, plays: 1, lastPlayed: new Date(song.time).getTime() });
                        }

                        /*
                        if (new Date(song.time).getHours() < (EarliestTime || 12)) {
                            EarliestTime = {
                                hour: new Date(song.time).getHours(),
                                type: (new Date(song.time).getHours() >= 12) ? "PM" : "AM"
                            }
                        }

                        if (new Date(song.time).getHours() > (LatestTime || 0)) {
                            LatestTime = {
                                hour: new Date(song.time).getHours(),
                                type: (new Date(song.time).getHours() >= 12) ? "PM" : "AM"
                            }
                        }
                        */
                    }
                })

                MostPlayed = [...SongPlays].sort((a, b) => b.plays - a.plays).splice(0, 3);
                MostActiveArtist = [...ArtistPlays].sort((a, b) => b.plays - a.plays).splice(0, 5);
                MostActiveWeekDay = DaysOfTheWeek.sort((a, b) => b.plays - a.plays)[0]

                Data.innerHTML = `
                <div class="col-md-5">
                    <div class="card mb-3">
                        <div class="card-header">TOP ARTIST</div>
                        <div class="card-body">
                            <h2 class="mb-0">${MostActiveArtist[0].name}</h2>
                            <small>${MostActiveArtist[0].plays} STREAMS (~${Math.floor((MostActiveArtist[0].plays / ThisYear.length) * 100)}% of all songs streamed)</small>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">2ND TOP ARTIST</div>
                        <div class="card-body">
                            <h4 class="text-muted mb-0">${MostActiveArtist[1].name}</h4>
                            <small>${MostActiveArtist[1].plays} STREAMS (~${Math.floor((MostActiveArtist[1].plays / ThisYear.length) * 100)}% of all songs streamed)</small>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">3RD TOP ARTIST</div>
                        <div class="card-body">
                            <h4 class="text-muted mb-0">${MostActiveArtist[2].name}</h4>
                            <small>${MostActiveArtist[2].plays} STREAMS (~${Math.floor((MostActiveArtist[2].plays / ThisYear.length) * 100)}% of all songs streamed)</small>
                        </div>
                    </div>

                    <small>RUNNER UPS</small>
                    <ul>
                        <li>4. ${MostActiveArtist[3].name} ( ${MostActiveArtist[3].plays} STREAMS = ~${Math.floor((MostActiveArtist[3].plays / ThisYear.length) * 100)}% of all streamed songs)</li>
                        <li>5. ${MostActiveArtist[4].name} ( ${MostActiveArtist[4].plays} STREAMS = ~${Math.floor((MostActiveArtist[4].plays / ThisYear.length) * 100)}% of all streamed songs)</li>
                    </ul>
                </div>
                <div class="col-auto" style="--bs-gutter-x: 1px;">
                    <hr style="color: inherit; height: 100%; border: 0.5px solid; margin: 0px;"></hr>
                </div>
                <div class="col">
                    <div class="card mb-3">
                        <div class="card-header">TOP SONG</div>
                        <div class="card-body">
                            <h2 class="mb-0">"${MostPlayed[0].name}"</h2>
                            <small>BY <code>${MostPlayed[0].artist}</code> WITH <code>${MostPlayed[0].plays.toLocaleString()}</code> STREAMS OF THIS SONG</small>
                        </div>
                    </div>
                    <div class="row text-center mb-3">
                        <div class="col">
                            <div class="card">
                                <div class="card-header">SONGS</div>
                                <div class="card-body">
                                    <h4 class="mb-0">${ThisYear.length.toLocaleString()}</h4>
                                    <small>STREAMED</small>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card">
                                <div class="card-header">UNIQUE SONGS</div>
                                <div class="card-body">
                                    <h4 class="mb-0">${SongPlays.length.toLocaleString()}</h4>
                                    <small>STREAMED</small>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card">
                                <div class="card-header">UNIQUE ARTISTS</div>
                                <div class="card-body">
                                    <h4 class="mb-0">${ArtistPlays.length.toLocaleString()}</h4>
                                    <small>STREAMED</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col">
                            <div class="card">
                                <div class="card-header">MOST STREAMED WEEK DAY</div>
                                <div class="card-body">
                                    <h4 class="mb-0">${MostActiveWeekDay.day}</h4>
                                    <small>${MostActiveWeekDay.plays.toLocaleString()} STREAMS (~${Math.floor((MostActiveWeekDay.plays / ThisYear.length) * 100)}% of all songs streamed)</small>
                                </div>
                            </div>
                        </div>
                        <!--
                        <div class="col">
                            <div class="card">
                                <div class="card-header">EARLIEST - LATEST</div>
                                <div class="card-body">
                                    <h4 class="mb-0">${EarliestTime.hour} ${EarliestTime.type} - ${LatestTime.hour} ${LatestTime.type}</h4>
                                    <small>PLAY TIME</small>
                                </div>
                            </div>
                        </div>
                        -->
                    </div>
                </div>
                `
                FileSelect.parentElement.remove()
                Page.classList.remove('d-none')
            }
        </script>
    </body>
</html>